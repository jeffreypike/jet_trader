import numpy as np
import pandas as pd

class Agent:
    def __init__(self, model, state_size, action_size = 3):
        self.model = model
        self.state_size = state_size
        self.action_size = action_size

    def load(self, filename):
        self.model.load_weights(filename)
    
    def save(self, filename):
        self.model.save_weights(filename)     

class QTrader(Agent):
    
    def __init__(self, gamma = 0.9, epsilon = 1.0, epsilon_min = 0.01, epsilon_decay = 0.995):
        super().__init__()
        self.gamma = gamma  # discount factor
        self.epsilon = epsilon   # exploration rate
        self.epsilon_min = epsilon_min   # never stop exploring!
        self.epsilon_decay = epsilon_decay   # but maybe do some exploiting too...
    
    def act(self, state):
        if np.random.rand() <= self.epsilon:
            return np.random.choice(self.action_size) - 1  
        act_values = self.model.predict(state)
        return np.argmax(act_values[0]) - 1   # return greedy action unless exploring
    
    def train(self, state, action, reward, next_state, done):
        if done:
            target = reward
        else:
            target = reward + self.gamma * np.amax(self.model.predict(next_state), axis = 1)
        
        target_full = self.model.predict(state)
        target_full[0, action] = target
        
        self.model.sgd(state, target_full)   # perform one step of gradient descent
        
        if self.epsilon > self.epsilon_min:
            self.epsilon *= self.epsilon_decay   # as we learn more, we explore less

class ActorCriticTrader(Agent):

    def __init__(self, model, state_size, action_size = 3, gamma = 0.99):
        super().__init__(model = model, state_size = state_size, action_size = action_size)
        self.gamma = gamma  # discount factor
    
    def act(self, state):
        action_probs = self.model.predict(state)[0].squeeze()
        return np.random.choice(3, p = action_probs) - 1
    
    def train(self, state, action, reward, next_state, done):
        if done:
            G = reward
        else:
            G = reward + self.gamma * self.model.predict(next_state)[1]
        
        action_index = [-1, 0, 1].index(action)
        target = [action_index, G]
        self.model.sgd(state, target)   # perform one step of gradient descent

# class EvolutionTrader:   # WIP

#     def __init__(self, model, state_size, action_size = 3, population_size = 30, sigma = 0.1, learning_rate = 0.03):
#         self.model = model
#         self.state_size = state_size
#         self.action_size = action_size

#         self.population_size = population_size   # number of children per generation
#         self.sigma = sigma   # std deviation of noise
#         self.learning_rate = learning_rate   # learning rate

#     def act(self, state):
#         act_values = self.model.predict(state)
#         return np.argmax(act_values[0]) - 1   # greedy policy, exploration built-in
    
#     def evolve_model(self, reward_function):   # reward_function plays one episode and returns reward.  Appears in training script.
#         pool = Pool(4)
#         weights = self.model.get_weights()
#         noise = np.random.randn(self.population_size, len(weights))
        
#         # no multithreading (slow)
#         # rewards = np.zeros(self.population_size)
#         # for j in range(self.population_size):
#         #     weights_try = weights + self.sigma * noise[j]
#         #     rewards[j] = reward_function[weights_try]
        
#         # multithreading (fast)
#         rewards = pool.map(reward_function, [weights + self.sigma * noise[j] for j in range(self.population_size)])
#         rewards = np.array(rewards)

#         update = (rewards - rewards.mean()) / rewards.std()
#         weights += self.learning_rate * noise.T.dot(update) / self.sigma * self.population_size

#         self.learning_rate *= 0.992354
#         self.model.set_weights(weights)
#         return rewards.mean()
        
        

    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
